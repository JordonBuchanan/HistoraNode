var express         = require("express"),
     app            = express(),
     bodyParser     = require("body-parser"),
     nodemailer     = require("nodemailer"),
     methodOverride = require("method-override"),
     session        = require("express-session"),
     LocalStrategy  = require("passport-local"),
     cookieParser   = require("cookie-parser"),
     mongoose       = require("mongoose"),
     passport       = require("passport"),
     Comment        = require('./models/comment'),
     User           = require('./models/user');

app.use(bodyParser.urlencoded({extended: true}));
app.use(express.static(__dirname + '/Views/public'));
app.set('views', __dirname + '/Views');
app.use(express.static('files'));
app.use(methodOverride('_method'));
app.use(cookieParser('secret'));
app.set("view engine", "ejs");

// PASSPORT CONFIGURATION
app.locals.moment = require('moment');
app.use(require("express-session")({
    secret: "CharlesMartell",
    resave: false,
    saveUninitialized: false
}));

app.use(passport.initialize());
app.use(passport.session());
passport.use(new LocalStrategy(User.authenticate()));
passport.serializeUser(User.serializeUser());
passport.deserializeUser(User.deserializeUser());
app.use(function(req, res, next){
    res.locals.currentUser = req.user;
    next();
 });

//SCHEMA SETUP
mongoose.connect('mongodb://localhost/histora');
mongoose.Promise = global.Promise;
var db = mongoose.connection;
var PostSchema = new mongoose.Schema({
    name: String,
    createdAt: { type: Date, default: Date.now },
    image: String,
    text: String,
    author:{
        id:{
            type: mongoose.Schema.Types.ObjectId,
            ref: "User"
        },
        username: String
    },
    comments: [
        {
            type: mongoose.Schema.Types.ObjectId,
            ref: "Comment"
        }
    ]
});
var Post = mongoose.model("Post", PostSchema);

process.on('unhandledRejection', (reason, p) => {
    console.log('Unhandled Rejection at: Promise', p, 'reason:', reason);
    // application specific logging, throwing an error, or other logic here
  });

//==================
//GET ROUTES
//==================

app.get("/", function(req, res){
    res.render("Home.ejs");
});

app.get("/Forum/new", isLoggedIn, function(req, res){
    res.render("new.ejs")
});

app.get("/Forum", isLoggedIn, function(req, res){
    Post.find({}, function(err, allPost){
        if(err){
            console.log(err);
        } else {
            res.render("Forum", {Post:allPost});
        }
    });
});

app.get("/Forum/:id", isLoggedIn, function(req, res){
    Post.findById(req.params.id).populate("comments").exec(function(err, foundPost){
        if(err){
            console.log(err);
        } else{
            res.render("show", {Post: foundPost});
        }
    })
});

//===================
//POST ROUTES
//===================

app.post("/Forum", isLoggedIn, function(req, res){
    var name = req.body.name;
    var image = req.body.image;
    var text = req.body.text;
    var author = {
        id: req.user._id,
        username: req.user.username
    }
    var newPost = {name: name, image: image, text: text, author:author}
//get data from form and add to posts array
    Post.create(newPost, function(err, newlyCreated){
        if(err){
            console.log(err);
        } else{
            res.redirect("/Forum");
        }
    });
});

//===============
//COMMENT ROUTES
//==============

app.get("/Forum/:id/newcomment", isLoggedIn, function(req, res){
    Post.findById(req.params.id, function(err, Post){
        if(err){
            console.log(err);
        } else{
            res.render("newcomment", {Post: Post});
        }
    }); 
});

app.post("/Forum/:id/comments", isLoggedIn, function(req,res){
    Post.findById(req.params.id, function(err, Post){
        if(err){
            console.log(err);
            res.redirect("/Forum");
        }else {
            Comment.create(req.body.comment, function(err, comment){
                if(err){
                    console.log(err);
                } else{
                    comment.author.id = req.user._id;
                    comment.author.username = req.user.username;
                    comment.save();
                    Post.comments.push(comment);
                    Post.save();
                    res.redirect("/Forum/" + Post._id);
                }
            });
        }
    });
});

//================
//AUTH ROUTE
//================

app.post("/register", function(req, res){
    var newUser = new User(
        {
            username: req.body.username,
            firstName: req.body.firstName,
            lastName: req.body.lastName,
            website: req.body.website,
            email: req.body.email
        });
    User.register(newUser, req.body.password, function(err, user){
       if(err){
           console.log(err);
           return res.render("register")
       }
       passport.authenticate("local")(req, res, function(){
          res.redirect("/Forum");
       })
    })
});

app.post("/login", passport.authenticate("local", 
    {
        successRedirect: "/Forum",
        failureRedirect: "/"
    }), function(req, res){
});

app.get("/logout", function(req, res){
    req.logout();
    res.redirect("/");
});

function isLoggedIn(req, res, next){
    if(req.isAuthenticated()){
        return next();
    }
    res.redirect("/");
}

//================
//ALL ROUTE
//================

app.get("*", function(req, res){
    res.render("all.ejs")
});

//================
//LISTEN
//================

var server     =    app.listen(process.env.PORT || 3000,function(){
    console.log("We have started our server on port 3000");
});